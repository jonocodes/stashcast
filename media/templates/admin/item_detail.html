{% extends "admin/base_site.html" %}
{% load media_filters %}
{% load static %}
{% load i18n %}

{% block title %}{{ item.title|default:"Untitled" }} - StashCast{% endblock %}

{% block extrastyle %}
<style>
    :root {
        --sc-panel-bg: var(--body-bg, #ffffff);
        --sc-panel-fg: var(--body-fg, #222222);
        --sc-muted: var(--body-quiet-color, #6b7280);
        --sc-border: var(--border-color, #d4d4d4);
        --sc-primary: var(--primary, #417690);
        --sc-primary-fg: var(--primary-fg, #ffffff);
        --sc-surface: var(--darkened-bg, rgba(0,0,0,0.02));
    }
    .dark {
        --sc-panel-bg: #1e293b;
        --sc-panel-fg: #e2e8f0;
        --sc-muted: #94a3b8;
        --sc-border: #334155;
        --sc-primary: #60a5fa;
        --sc-primary-fg: #ffffff;
        --sc-surface: rgba(255,255,255,0.06);
    }

    .item-detail-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background: var(--sc-panel-bg);
        border: 1px solid var(--sc-border);
        border-radius: 8px;
    }
    h1 {
        margin: 0 0 15px 0;
        color: var(--sc-panel-fg);
    }
    .action-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
        padding: 12px 16px;
        background: var(--sc-surface);
        border-radius: 6px;
        align-items: center;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-right: 8px;
        margin-bottom: 20px;
    }
    .status-ready { background: color-mix(in srgb, #28a745 20%, transparent); color: #28a745; }
    .status-archived { background: color-mix(in srgb, #6c757d 20%, transparent); color: var(--sc-muted); }
    .status-error { background: color-mix(in srgb, #dc3545 20%, transparent); color: #dc3545; }
    .status-processing { background: color-mix(in srgb, #ffc107 20%, transparent); color: #b38600; }
    .status-downloading { background: color-mix(in srgb, #17a2b8 20%, transparent); color: #17a2b8; }
    .status-prefetching { background: color-mix(in srgb, #6c757d 20%, transparent); color: var(--sc-muted); }
    .dark .status-processing { color: #ffc107; }
    .dark .status-archived { color: #94a3b8; }
    .action-bar .separator {
        width: 1px;
        height: 20px;
        background: var(--sc-border);
        margin: 0 4px;
    }
    .action-bar .btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.15s ease;
        background: var(--sc-panel-bg);
        color: var(--sc-panel-fg);
        border-color: var(--sc-border);
    }
    .action-bar .btn:hover {
        background: var(--sc-surface);
        text-decoration: none;
    }
    .action-bar .btn-danger {
        color: #dc3545;
        border-color: #dc3545;
        background: transparent;
    }
    .action-bar .btn-danger:hover {
        background: #dc3545;
        color: white;
    }
    .action-bar form {
        margin: 0;
        display: inline-flex;
    }
    .metadata {
        color: var(--sc-muted);
        font-size: 14px;
        margin-bottom: 20px;
    }
    .metadata div {
        margin-bottom: 5px;
    }
    .thumbnail {
        width: 100%;
        max-width: 400px;
        margin: 20px 0;
        border-radius: 4px;
    }
    .summary {
        background: var(--sc-surface);
        border-left: 4px solid var(--sc-primary);
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
    }
    .summary h3 {
        margin: 0 0 10px 0;
        color: var(--sc-primary);
        font-size: 16px;
    }
    .description {
        line-height: 1.6;
        color: var(--sc-panel-fg);
        white-space: pre-wrap;
    }
    .description h3 {
        margin: 0 0 10px 0;
        color: var(--sc-panel-fg);
    }
    .player {
        margin: 30px 0;
        width: 100%;
    }
    audio, video {
        width: 100%;
        border-radius: 4px;
    }
    .error-message {
        background: color-mix(in srgb, #dc3545 15%, transparent);
        border: 1px solid color-mix(in srgb, #dc3545 30%, transparent);
        color: #dc3545;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="item-detail-container">

    {% if item.status == 'READY' %}
        <!-- <span class="status-badge status-ready">{% trans "Ready" %}</span> -->
    {% elif item.status == 'ARCHIVED' %}
        <span class="status-badge status-archived">{% trans "Archived" %}</span>
    {% elif item.status == 'ERROR' %}
        <span class="status-badge status-error">{% trans "Error" %}</span>
    {% elif item.status == 'PROCESSING' %}
        <span class="status-badge status-processing">{% trans "Processing" %}</span>
    {% elif item.status == 'DOWNLOADING' %}
        <span class="status-badge status-downloading">{% trans "Downloading" %}</span>
    {% else %}
        <span class="status-badge status-prefetching">{% trans "Prefetching" %}</span>
    {% endif %}

    <h1>{{ item.title|default:"Untitled" }}</h1>

    <div class="action-bar">

        <span class="separator"></span>

        <a href="{% url 'admin:media_mediaitem_change' item.guid %}" class="btn">{% trans "Edit" %}</a>
        {% if item.status == 'READY' %}
            <form method="post" action="{% url 'item_archive' item.guid %}">
                {% csrf_token %}
                <button type="submit" class="btn">{% trans "Archive" %}</button>
            </form>
        {% elif item.status == 'ARCHIVED' %}
            <form method="post" action="{% url 'item_unarchive' item.guid %}">
                {% csrf_token %}
                <button type="submit" class="btn">{% trans "Unarchive" %}</button>
            </form>
        {% endif %}
        <a href="{% url 'admin:media_mediaitem_delete' item.guid %}" class="btn btn-danger">{% trans "Delete" %}</a>

        <form method="post" action="{% url 'item_refetch' item.guid %}">
            {% csrf_token %}
            <button type="submit" class="btn">{% trans "Refetch" %}</button>
        </form>
        {% if item.subtitle_path %}
            <form method="post" action="{% url 'item_regenerate_summary' item.guid %}">
                {% csrf_token %}
                <button type="submit" class="btn">{% if item.summary %}{% trans "Regenerate Summary" %}{% else %}{% trans "Generate Summary" %}{% endif %}</button>
            </form>
        {% endif %}

        {% if item.is_ready and media_url %}
            <span class="separator"></span>
            <a href="{{ media_url }}" download class="btn">{% trans "Download" %} {{ item.media_type|title }}</a>
            {% if subtitle_url %}
                <a href="{{ subtitle_url }}" download class="btn">{% trans "Download Subtitles" %}</a>
            {% endif %}
        {% endif %}

        {% if item.webpage_url %}
            <span class="separator"></span>
            <a href="{{ item.webpage_url }}" target="_blank" class="btn">{% trans "Source" %}</a>
        {% endif %}
    </div>

    <div class="metadata">
        {% if item.author %}
            <div><strong>{% trans "By:" %}</strong> {{ item.author }}</div>
        {% endif %}
        {% if item.publish_date %}
            <div><strong>{% trans "Published:" %}</strong> {{ item.publish_date|date:"F j, Y" }}</div>
        {% endif %}
        {% if item.duration_seconds %}
            <div><strong>{% trans "Duration:" %}</strong> {{ item.duration_seconds|duration }}</div>
        {% endif %}
        <div><strong>{% trans "Type:" %}</strong> {{ item.media_type|title }}</div>
    </div>

    {% if item.has_error %}
        <div class="error-message">
            <strong>{% trans "Error:" %}</strong> {{ item.error_message }}
        </div>
    {% endif %}

    {% if item.thumbnail_path and thumbnail_url %}
        <img src="{{ thumbnail_url }}" alt="{{ item.title }}" class="thumbnail">
    {% endif %}

    {% if item.summary %}
        <div class="summary">
            <h3>{% trans "Summary" %}</h3>
            <p>{{ item.summary }}</p>
        </div>
    {% endif %}

    {% if item.description %}
        <div class="description">
            <h3>{% trans "Description" %}</h3>
            {{ item.description }}
        </div>
    {% endif %}

    {% if item.is_ready and media_url %}
        <div class="player">
            {% if item.media_type == 'audio' %}
                <audio controls>
                    <source src="{{ media_url }}" type="{{ item.mime_type }}">
                    {% trans "Your browser does not support audio element." %}
                </audio>
            {% else %}
                <video controls>
                    <source src="{{ media_url }}" type="{{ item.mime_type }}">
                    {% if subtitle_url %}
                        <track kind="subtitles" src="{{ subtitle_url }}" srclang="en" label="English">
                    {% endif %}
                    {% trans "Your browser does not support video element." %}
                </video>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}
