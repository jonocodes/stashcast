{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Bookmarklet Tool" %}{% endblock %}

{% block extrastyle %}
<style>
    :root {
        --sc-panel-bg: var(--body-bg, #ffffff);
        --sc-panel-fg: var(--body-fg, #222222);
        --sc-muted: var(--body-quiet-color, #6b7280);
        --sc-border: var(--hairline-color, #d4d4d4);
        --sc-primary: var(--primary, #417690);
        --sc-primary-fg: var(--primary-fg, #ffffff);
        --sc-surface: var(--darkened-bg, rgba(0,0,0,0.02));
    }
    .container {
        background: var(--sc-panel-bg);
        color: var(--sc-panel-fg);
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid var(--sc-border);
    }
    h1 {
        color: var(--sc-panel-fg);
        margin-top: 0;
    }
    h2 {
        color: var(--sc-panel-fg);
        margin-top: 30px;
        border-bottom: 2px solid var(--sc-primary);
        padding-bottom: 10px;
    }
    .explainer {
        background: color-mix(in srgb, var(--sc-surface) 70%, transparent);
        border-left: 4px solid var(--sc-primary);
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        border: 1px solid var(--sc-border);
    }
    .form-group {
        margin: 20px 0;
    }
    label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--sc-panel-fg);
    }
    input[type="text"], input[type="url"], select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--sc-border);
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
        background: var(--sc-surface);
        color: var(--sc-panel-fg);
    }
    input[type="text"]:focus, input[type="url"]:focus, select:focus {
        outline: none;
        border-color: var(--sc-primary);
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--sc-primary) 25%, transparent);
    }
    .bookmarklet-link {
        display: inline-block;
        padding: 12px 24px;
        background: var(--sc-primary);
        color: var(--sc-primary-fg);
        text-decoration: none;
        border-radius: 4px;
        font-weight: 600;
        margin: 20px 0;
        cursor: move;
    }
    .bookmarklet-link:hover {
        filter: brightness(1.05);
    }
    textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid var(--sc-border);
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        box-sizing: border-box;
        background: var(--sc-surface);
        color: var(--sc-panel-fg);
    }
    button {
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
    }
    button:hover {
        filter: brightness(1.05);
    }
    .copy-button {
        background: #6c757d;
    }
    .instruction {
        background: color-mix(in srgb, #ffc107 20%, transparent);
        border: 1px solid color-mix(in srgb, #ffc107 50%, transparent);
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
        color: var(--sc-panel-fg);
    }
    .status-info {
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
        border: 1px solid;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    .status-info.protected {
        background: color-mix(in srgb, #22c55e 10%, transparent);
        border-color: #22c55e;
    }
    .status-info.public {
        background: color-mix(in srgb, #f59e0b 10%, transparent);
        border-color: #f59e0b;
    }
    .status-info-icon {
        font-size: 20px;
        flex-shrink: 0;
    }
    code {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{% trans "StashCast Bookmarklet Tool" %}</h1>

    <div class="explainer">
        <strong>{% trans "What is a bookmarklet?" %}</strong><br>
        {% trans "A bookmarklet is a bookmark that runs JavaScript to perform actions on the current page. Drag the bookmarklet link below to your bookmarks bar, then click it on any page with media you want to download to StashCast." %}
    </div>

    {% if require_user_token_for_feeds %}
    <div class="status-info protected">
        <span class="status-info-icon">üîí</span>
        <div>
            <strong>{% trans "Feed Protection Enabled" %}</strong><br>
            {% trans "Your RSS feeds require a user token. Feed URLs in this instance automatically include the token for privacy." %}
        </div>
    </div>
    {% else %}
    <div class="status-info public">
        <span class="status-info-icon">üåê</span>
        <div>
            <strong>{% trans "Public Feeds Notice" %}</strong><br>
            {% trans "RSS feeds are currently publicly accessible. To require user tokens for feeds, set REQUIRE_USER_TOKEN_FOR_FEEDS=true in your environment configuration." %}
        </div>
    </div>
    {% endif %}

    <h2>{% trans "1. Configure Bookmarklet" %}</h2>

    <form id="bookmarklet-form">
        <div class="form-group">
            <label for="base-url">{% trans "Base URL:" %}</label>
            <input type="url" id="base-url" value="{{ base_url }}" required>
            <small>{% trans "The base URL of your StashCast instance" %}</small>
        </div>

        <div class="form-group">
            <label for="media-type">{% trans "Default Media Type:" %}</label>
            <select id="media-type">
                <option value="auto" selected>{% trans "Auto" %}</option>
                <option value="audio">{% trans "Audio" %}</option>
                <option value="video">{% trans "Video" %}</option>
            </select>
            <small>{% trans "What type of media to download by default" %}</small>
        </div>

        <div class="form-group">
            <label for="close-tab-after">{% trans "Auto-close Progress Tab (seconds):" %}</label>
            <input type="number" id="close-tab-after" min="1" step="1" placeholder="{% trans 'Optional' %}">
            <small>{% trans "Close the progress tab after the job completes; leave blank to keep it open" %}</small>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="allow-multiple">
                {% trans "Allow Multiple Items" %}
            </label>
            <small>{% trans "If enabled, automatically download all items from playlists or pages with multiple videos. If disabled, you'll get an error prompting you to confirm in admin." %}</small>
        </div>
    </form>

    <h2>{% trans "2. Your Bookmarklet" %}</h2>

    <div class="instruction">
        <strong>{% trans "Installation:" %}</strong> {% trans "Drag the button below to your bookmarks bar. If your bookmarks bar is hidden, enable it in your browser settings first." %}
    </div>

    <a href="#" id="bookmarklet" class="bookmarklet-link">
        üì• {% trans "Stash to StashCast" %}
    </a>

    <h2>{% trans "3. JavaScript Code" %}</h2>

    <p>{% trans "You can also copy the JavaScript code below and create a bookmark manually:" %}</p>

    <textarea id="bookmarklet-code" readonly></textarea>

    <div style="margin-top: 10px;">
        <button class="copy-button" onclick="copyCode()">{% trans "Copy Code" %}</button>
    </div>

    <h2>{% trans "4. Test It" %}</h2>

    <form id="test-form" style="margin-top: 20px;">
        <div class="form-group">
            <label for="test-url">{% trans "Test URL:" %}</label>
            <input type="url" id="test-url" placeholder="https://example.com/video" required>
        </div>
        <button type="submit">{% trans "Test Bookmarklet" %}</button>
    </form>
</div>

<script>
    const userToken = '{{ user_token }}';

    function generateBookmarklet() {
        const baseUrl = document.getElementById('base-url').value;
        const mediaType = document.getElementById('media-type').value;
        const closeTabAfter = document.getElementById('close-tab-after').value;
        const allowMultiple = document.getElementById('allow-multiple').checked;
        const closeParam = closeTabAfter ? `&closeTabAfter=${encodeURIComponent(closeTabAfter)}` : '';
        const multipleParam = allowMultiple ? '&allow_multiple=true' : '';

        const code = `javascript:(function(){
            const url = encodeURIComponent(window.location.href);
            const stashUrl = '${baseUrl}/stash/?token=${userToken}&url=' + url + '&type=${mediaType}${multipleParam}';
            window.open(stashUrl, '_blank');
        })();`;

        const progressCode = `javascript:(function(){
            const url = encodeURIComponent(window.location.href);
            const stashUrl = '${baseUrl}/stash/?token=${userToken}&url=' + url + '&type=${mediaType}&redirect=progress${closeParam}${multipleParam}';
            window.open(stashUrl, '_blank');
        })();`;

        const bookmarklet = document.getElementById('bookmarklet');
        const codeTextarea = document.getElementById('bookmarklet-code');

        bookmarklet.href = progressCode;
        codeTextarea.value = progressCode;
    }

    function copyCode() {
        const codeTextarea = document.getElementById('bookmarklet-code');
        codeTextarea.select();
        document.execCommand('copy');
        alert('Code copied to clipboard!');
    }

    document.getElementById('base-url').addEventListener('input', generateBookmarklet);
    document.getElementById('media-type').addEventListener('change', generateBookmarklet);
    document.getElementById('close-tab-after').addEventListener('input', generateBookmarklet);
    document.getElementById('allow-multiple').addEventListener('change', generateBookmarklet);

    document.getElementById('test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const testUrl = document.getElementById('test-url').value;
        const baseUrl = document.getElementById('base-url').value;
        const mediaType = document.getElementById('media-type').value;
        const closeTabAfter = document.getElementById('close-tab-after').value;
        const allowMultiple = document.getElementById('allow-multiple').checked;
        const closeParam = closeTabAfter ? `&closeTabAfter=${encodeURIComponent(closeTabAfter)}` : '';
        const multipleParam = allowMultiple ? '&allow_multiple=true' : '';

        const stashUrl = `${baseUrl}/stash/?token=${userToken}&url=${encodeURIComponent(testUrl)}&type=${mediaType}&redirect=progress${closeParam}${multipleParam}`;
        window.open(stashUrl, '_blank');
    });

    // Initialize on page load
    generateBookmarklet();
</script>
{% endblock %}
